/*
 # -----------------------------------------------------------------------------
 # ~/assets/theme/j1/adapter/js/gemini.js
 # J1 Adapter for the Google Gemini API module
 #
 # Product/Info:
 # https://jekyll.one
 #
 # Copyright (C) 2023-2025 Juergen Adams
 #
 # J1 Template is licensed under the MIT License.
 # For details, see: https://github.com/jekyll-one-org/j1-template/blob/main/LICENSE
 # -----------------------------------------------------------------------------
 # NOTE:
 # -----------------------------------------------------------------------------
 #  Adapter generated: 2025-07-05 06:15:45 +0200
 # -----------------------------------------------------------------------------
*/
"use strict";j1.adapter.gemini=((e,t)=>{function o(e){var t=1;e.forEach(()=>{var e='opt_prompt_history_'+t,o=document.getElementById(e),a=setInterval(()=>{0!==$(o).length&&(w.debug('add eventListener to: '+e),o.addEventListener('click',n),clearInterval(a))},10);t++})}function n(t){var o,n,a,s=t.currentTarget.nextSibling.data,r=C.getData(),i=[],d=e.existsCookie(l.chat_prompt)?e.readCookie(l.chat_prompt):{};t.preventDefault(),t.stopPropagation(),o=-1;for(var c=0;c<r.length;c++)if(r[c].text===s){o=c;break}-1!==o&&(delete r[o],a=Object.values(r),C!==undefined||null!==C?C.setData(a):w.error('FATAL: slimSelect NOT available')),o=-1,i=Object.values(d);for(c=0;c<i.length;c++)if(i[c]===s){o=c;break}if(-1!==o){if(delete i[o],(n=Object.values(i)).length>1){var m=[...new Set(n)];n=Object.values(m)}S&&(w.debug('save prompt history to cookie'),n.length>0?(e.removeCookie({name:l.chat_prompt}),e.writeCookie({name:l.chat_prompt,data:n,secure:p}),$("#clear").show()):(e.removeCookie({name:l.chat_prompt}),w.info('spanElementEventListener, hide prompt history on last element'),$("#prompt_history_container").hide(),$("#clear").hide()))}w.info('spanElementEventListener, option deleted:\n'+s),C===undefined||null===C?w.error('FATAL: slimSelect NOT available'):C.close()}function a(e){f=e.coords.latitude,E=e.coords.longitude,fetch(`//nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${f}&lon=${E}`).then(e=>e.json()).then(e=>{y=e.address.country,b=e.address.city,$("#modal_error").html(X+"<br><b>"+y+'</b>'),w.warn('location is not supported: '+y+':'+b)})["catch"](e=>{w.error('error detect location: '+e)})}function s(){function e(e){f=e.coords.latitude,E=e.coords.longitude,a(e)}function t(){w.warn('Unable to retrieve the location')}navigator.geolocation?navigator.geolocation.getCurrentPosition(e,t):w.warn('Geolocation API is not supported by the browser')}async function r(){document.getElementById("name");const e=_.getGenerativeModel({model:c,safetySettings:j,generationConfig:U});var t=$('textarea#prompt').val();for(0===t.length&&(t=ne.replace(/\s+$/g,''),w.debug('use default prompt: '+t),document.getElementById('prompt').value=t),M=Date.now(),h=1,w.info('processing request: started');h<=J;)try{w.debug('processing request: #'+h+'|'+J),g=await e.generateContent(t);break}catch(f){var o=f.toString();o.includes('400')?(400,X=ae,oe.detect_geo_location?(s(),$("#modal_error").html(X)):($("#modal_error").html(X),w.warn('location not supported'))):o.includes('50')&&(500,X=se,$("#modal_error").html(X),w.warn('service not available')),F=!0}finally{if(F)3===h&&(w.debug('requests failed after max retries: '+J),$("#spinner").hide(),oe.detectGeoLocation&&s(),setTimeout(()=>{$('#confirmError').modal('show')},1e3)),h++;else try{w.debug('collecting results ...'),K=await g.response}catch(f){w.warn(f)}finally{$("#spinner").hide();var n,a,r,i,l,d=oe.api_options.candidateRatings,p='';if(K.promptFeedback!==undefined){if(n=K.promptFeedback.safetyRatings,'SAFETY'===K.promptFeedback.blockReason){n.forEach(e=>{e.probability!==undefined&&'NEGLIGIBLE'!==e.probability&&'LOW'!==e.probability&&e.category!==undefined&&(i=e.category,l=e.probability)}),i!==undefined&&''!==i&&l!==undefined&&''!==l&&w.warn('Security issue detected, reason: '+i+' = '+l);var m=i.replace("HARM_CATEGORY_",'').toLowerCase(),u=l.toLowerCase();p='Response disabled due to security reasons (<b>'+m+': '+u+'</b>). Please modify your prompt.'}K.text!==undefined&&K.text.length>0&&(p=K.text)}if(K.candidates!==undefined){if(n=K.candidates[0].safetyRatings,'STOP'===K.candidates[0].finishReason){for(const[e,t]of Object.entries(d))n.forEach(e=>{'HARM_CATEGORY_DANGEROUS_CONTENT'!==e&&'HARM_CATEGORY_HARASSMENT'!==e.category&&'HARM_CATEGORY_HATE_SPEECH'!==e.category&&'HARM_CATEGORY_SEXUALLY_EXPLICIT'!==e.category||("NEGLIGIBLE"!==e.probability?("BLOCK_NONE"===d.HARM_CATEGORY_DANGEROUS_CONTENT&&(r=e.category,a=d.HARM_CATEGORY_DANGEROUS_CONTENT,p=K.candidates[0].content.parts[0].text),"BLOCK_NONE"===d.HARM_CATEGORY_HARASSMENT&&(r=e.category,a=d.HARM_CATEGORY_HARASSMENT,p=K.candidates[0].content.parts[0].text),"BLOCK_NONE"===d.HARM_CATEGORY_HATE_SPEECH&&(r=e.category,a=d.HARM_CATEGORY_HATE_SPEECH,p=K.candidates[0].content.parts[0].text),"BLOCK_NONE"===d.HARM_CATEGORY_SEXUALLY_EXPLICIT&&(r=e.category,a=d.HARM_CATEGORY_SEXUALLY_EXPLICIT,p=K.candidates[0].content.parts[0].text)):p=K.candidates[0].content.parts[0].text)});r!==undefined&&w.debug(r+': '+a)}'MAX_TOKENS'===K.candidates[0].finishReason&&(p='Response disabled due to model settings (<b>maxOutputTokens: '+oe.api_options.generationConfig.maxOutputTokens+'</b>). You need to increase your settings to get full response.'),'SAFETY'===K.candidates[0].finishReason&&(p='Response disabled due to security reasons. You need to <b>change your prompt</b> to get proper results.',console.warn('Response disabled due to security reasons')),'RECITATION'===K.candidates[0].finishReason&&(p='Response flagged "RECITATION". Resposne currently not supported',console.warn('finishReason "RECITATION" currently not supported')),'OTHER'===K.candidates[0].finishReason&&(p='Response disabled due to unknown reasons.',console.warn('Response disabled due to unknown reasons'))}p.length>0&&(p.length<oe.api_options.responseLengthMin?(w.warn('Response generated too short: <'+oe.api_options.responseLengthMin+' characters'),document.getElementById('md_result').innerHTML='Response generated too short (less than '+oe.api_options.responseLengthMin+' characters). Please re-run the generation for better results'):document.getElementById('md_result').innerHTML=marked.parse(p),$("#result").show(),$("#response").show())}}B=Date.now(),w.debug('request execution time: '+(B-M)+'ms'),w.info('processing request: finished')}"development"===e.env||e.env;var i,l,d,p,c,m,u,_,g,h,f,E,y,b,A,v,O,C,R,T,I,S,L,H,w,x,N,M,B,G,k,Y,P=document.createElement('script'),D=document.createElement('script'),j=[],U={},F=!1,K='',X='',q=!1,z=[],V={},J=3,W=!1,Q=$.extend({},{enabled:!1,api_options:{showSearch:!0,searchPlaceholder:"Enter your search expression",searchText:"No results",searchingText:"Searching ...",searchHighlight:!1,closeOnSelect:!0,contentPosition:"absolute",openPosition:"auto",placeholderText:"Select an item",allowDeselect:!1,hideSelected:!1,showOptionTooltips:!1,minSelected:0,maxSelected:1,timeoutDelay:200,maxValuesShown:20,maxValuesMessage:"{number} selected"}}),Z=$.extend({},{enabled:!1,selects:[{select:"icon_library",enabled:!1,wrapper_id:"icon_library_select_wrapper",id:"icon_library",name:"icon-library",items:"<select id=\"icon_library\" name=\"icon-library\">\n  <optgroup label=\"Material Design Icons (MDI)\">\n    <option value=\"mdi-icons-base\"        data-css=\"/assets/theme/j1/core/css/icon-fonts/mdib.min.css\" selected=\"selected\">MDI Icons Base</option>\n    <option value=\"mdi-icons-light\"       data-css=\"/assets/theme/j1/core/css/icon-fonts/mdil.min.css\">MDI Icons Light</option>\n    <option value=\"mdi-icons-regular\"     data-css=\"/assets/theme/j1/core/css/icon-fonts/mdi.min.css\">MDI Icons Regular</option>\n  </optgroup>\n\n  <optgroup label=\"Font Awesome Icons (FA)\">\n    <option value=\"font-awesome\"          data-css=\"/assets/theme/j1/core/css/icon-fonts/fontawesome.min.css\">FA Icons (all)</option>\n    <option value=\"font-awesome-solid\"    data-css=\"/assets/theme/j1/core/css/icon-fonts/fontawesome.min.css\">FA Icons Solid</option>\n    <option value=\"font-awesome-regular\"  data-css=\"/assets/theme/j1/core/css/icon-fonts/fontawesome.min.css\">FA Icons Regular</option>\n    <option value=\"font-awesome-brands\"   data-css=\"/assets/theme/j1/core/css/icon-fonts/fontawesome.min.css\">FA Icons Brands</option>\n  </optgroup>\n</select>\n"},{select:"prompt_history",enabled:!1,wrapper_id:"prompt_history_select_wrapper",id:"prompt_history",name:"prompt-history",items:"<select multiple=\"\" id=\"prompt_history\" name=\"prompt-history\"></select>"},{select:"search_history",enabled:!1,wrapper_id:"search_history_select_wrapper",id:"search_history",name:"search-history",items:"<select multiple=\"\" id=\"search_history\" name=\"search-history\"></select>"}]}),ee=($.extend(!0,{},Q,Z),$.extend({},{enabled:!1,xhr_data_path:"/assets/data/gemini-ui/index.html",xhr_container_id:"gemini_ui",xhr_data_element:"gemini_ui_container",detect_geo_location:!1,prompt_id:"prompt",prompt_history_id:"prompt_history",prompt_history_wrapper_id:"prompt_history_select_wrapper",prompt_history_max:30,prompt_history_enabled:!1,prompt_history_from_cookie:!0,allow_prompt_history_updates_on_max:!0,prompt:{size:7,title:"Prompt","default":"Please provide tips on how to use a prompt for the chatbot\n",placeholder:"Please enter a text describing the task or question for which the chatbot should process\n"},buttons:{generate:{id:"send",name:"Process prompt"},reset:{id:"reset",name:"Clear prompt"},clear:{id:"clear",name:"Clear last prompts"}},titles:{result:"Response",request_history:"Last Prompts",errorInfo:"API request failure"},errors:{http400:"Location is not supported",http500:"Service currently not available"},api_options:{model:"gemini-pro",maxApiRetries:3,responseLengthMin:10,enableCandidateFeedback:!0,generationConfig:{candidateCount:1,maxOutputTokens:65536,temperature:.5,topK:40,topP:.5},safetyRatings:{HARM_CATEGORY_DANGEROUS_CONTENT:"BLOCK_MEDIUM_AND_ABOVE",HARM_CATEGORY_HARASSMENT:"BLOCK_ONLY_HIGH",HARM_CATEGORY_HATE_SPEECH:"BLOCK_ONLY_HIGH",HARM_CATEGORY_SEXUALLY_EXPLICIT:"BLOCK_NONE"},candidateRatings:{HARM_CATEGORY_DANGEROUS_CONTENT:"BLOCK_MEDIUM_AND_ABOVE",HARM_CATEGORY_HARASSMENT:"BLOCK_ONLY_HIGH",HARM_CATEGORY_HATE_SPEECH:"BLOCK_ONLY_HIGH",HARM_CATEGORY_SEXUALLY_EXPLICIT:"BLOCK_NONE"}}})),te=$.extend({},{enabled:!1,detect_geo_location:!0,prompt_history_enabled:!0,api_options:{apiKey:"AIzaSyAtiLEW4oQiOJtGiPsdsGwMHi8O__7cqjU"}}),oe=$.extend(!0,{},ee,te);const ne=oe.prompt["default"],ae=oe.errors.http400,se=oe.errors.http500;return{init:o=>{$.extend({module_name:'j1.adapter.gemini',generated:'2025-07-05 06:15:45 +0200'},o);H=e.adapter.gemini,w=log4javascript.getLogger('j1.adapter.gemini'),l=e.getCookieNames(),i=new liteURL(t.location.href),i.origin,d=i.hostname,d.substring(d.lastIndexOf('.',d.lastIndexOf('.')-1)+1),p=!!i.protocol.includes('https'),I=oe.prompt_history_enabled,S=oe.prompt_history_from_cookie,H.loadModules(),H.loadUI();var n=setInterval(()=>{var t=$('#no_flicker').css("display"),o=$('#content').css("display"),a='block'===t&&'block'===o,s=!!document.getElementById(oe.prompt_history_id),r='success'===e.xhrDOMState['#gemini_ui'];if(a&&s&&r&&q){if(G=Date.now(),H.setState('started'),w.debug('set module state to: '+H.getState()),w.info('initializing module: started'),u||(w.warn('Invalid API key detected: '+m),w.debug('disable|hide all UI buttons'),$("#send").hide(),$("#reset").hide(),$("#clear").hide()),$("#gemini_ui_container").show(),$("#spinner").hide(),$("#response").hide(),(R=document.getElementById(oe.prompt_id)).value='',w.debug('initializing select data'),I&&S){O=document.getElementById(oe.prompt_history_id),(C=O.slim)!==undefined&&null!==C||w.error('FATAL: slimSelect NOT available'),T=oe.prompt_history_max,L=oe.allow_prompt_history_updates_on_max,w.debug('read prompt history from cookie');var i=[],d={};if(V=e.existsCookie(l.chat_prompt)?e.readCookie(l.chat_prompt):{},(z=Object.values(V)).length>1){var p=z.length,c=[...new Set(z)];p>(z=c).length&&w.debug('removed duplicates from history array: '+(p-z.length)+' element|s')}var _,g=1;i=[],d={};z.forEach(e=>{_='<span id="opt_'+oe.prompt_history_id+'_'+g+"\" class=\"ss-option-delete\"><i class=\"mdib mdib-close mdib-16px ml-1 mr-2\"></i></span>"+e,d={text:e,html:_,display:!0,selected:!1,disabled:!1},i.push(d),g++}),C!==undefined||null!==C?C.setData(i):w.error('FATAL: slimSelect NOT available'),z.length>0&&($("#prompt_history_container").show(),$("#clear").show()),H.setupSlimSelectEventHandlers()}else $("#clear").hide();H.setupUIButtonEventHandlers(),H.setState('finished'),w.debug('state: '+H.getState()),w.info('initializing module: finished'),k=Date.now(),w.info('module initializing time: '+(k-G)+'ms'),clearInterval(n)}},10)},loadModules:()=>{oe.detect_geo_location&&(P.async=!0,P.type="script",P.id='leaflet-api',P.src='//unpkg.com/leaflet/dist/leaflet.js',document.head.appendChild(P),D.async=!0,D.type="script",D.id='geocoder-api',D.src='//unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js',document.head.appendChild(D)),import('//esm.run/@google/generative-ai').then(e=>{w=log4javascript.getLogger('j1.adapter.gemini'),m=oe.api_options.apiKey,u=!m.includes('your-'),_=new e.GoogleGenerativeAI(m),N=e.HarmCategory,e.HarmBlockThreshold,c=oe.api_options.model,U={candidateCount:oe.api_options.generationConfig.candidateCount,maxOutputTokens:oe.api_options.generationConfig.maxOutputTokens,temperature:oe.api_options.generationConfig.temperature,topK:oe.api_options.generationConfig.topK,topP:oe.api_options.generationConfig.topP},j=[{category:N.HARM_CATEGORY_DANGEROUS_CONTENT,threshold:oe.api_options.safetyRatings.HARM_CATEGORY_DANGEROUS_CONTENT},{category:N.HARM_CATEGORY_HARASSMENT,threshold:oe.api_options.safetyRatings.HARM_CATEGORY_HARASSMENT},{category:N.HARM_CATEGORY_HATE_SPEECH,threshold:oe.api_options.safetyRatings.HARM_CATEGORY_HATE_SPEECH},{category:N.HARM_CATEGORY_SEXUALLY_EXPLICIT,threshold:oe.api_options.safetyRatings.HARM_CATEGORY_SEXUALLY_EXPLICIT}],w.debug('Importing Gemini module: successful'),q=!0})["catch"](e=>{(w=log4javascript.getLogger('j1.adapter.gemini')).warn('Importing Gemini module failed: '+e)})},loadUI:()=>{e.loadHTML({xhr_container_id:oe.xhr_container_id,xhr_data_path:oe.xhr_data_path,xhr_data_element:oe.xhr_data_element},'j1.adapter.gemini','null');var t=setInterval(()=>{'success'===e.xhrDOMState['#gemini_ui']&&(w.debug('Loading UI: successful'),clearInterval(t))},10)},setupSlimSelectEventHandlers:()=>{var t,n=document.getElementById(oe.prompt_history_id).slim;n.events.beforeOpen=(()=>{const t=n.getData();if(Y=!1,w.debug('slimSelect.beforeOpen, processing: started'),S){var a=e.existsCookie(l.chat_prompt)?e.readCookie(l.chat_prompt):{};z=Object.values(a);var s,r=1,i=[],d={};z.forEach(e=>{s='<span id="opt_'+oe.prompt_history_id+'_'+r+"\" class=\"ss-option-delete\"><i class=\"mdib mdib-close mdib-16px ml-1 mr-2\"></i></span>"+e,d={text:e,html:s,display:!0,selected:!1,disabled:!1},i.push(d),r++}),C!==undefined||null!==C?C.setData(i):w.error('FATAL: slimSelect NOT available')}t.length&&(w.debug('slimSelect.beforeOpen, number of eventListeners to process: #'+t.length),o(t));var p=1;t.forEach(()=>{var e='opt_prompt_history_'+p,o=document.getElementById(e),n=setInterval(()=>{!!$(o).length&&p===t.length&&(Y=!0,w.debug('slimSelect.beforeOpen, all eventListeners ready')),Y?clearInterval(n):p++},10)});var c=setInterval(()=>{Y&&(w.debug('slimSelect.beforeOpen, processing: finished'),clearInterval(c))},10)}),n.events.afterClose=(()=>{const e=n.getSelected();e.length?(t=e[0],document.getElementById('prompt').value=t,w.debug('slimSelect.afterClose, selection from history: '+t)):(w.debug('slimSelect.afterClose, selection from history: empty'),document.getElementById('prompt').value=''),C===undefined||null===C?w.error('FATAL: slimSelect NOT available'):C===undefined||null===C?w.error('FATAL: slimSelect NOT available'):C.setSelected('',!1)})},setupUIButtonEventHandlers:()=>{document.getElementById('send').addEventListener('click',t=>{if(t.preventDefault(),t.stopPropagation(),I){var o=!1;if(S){var n=e.existsCookie(l.chat_prompt)?e.readCookie(l.chat_prompt):{};z=Object.values(n)}if(0===R.value.length?(prompt=ne.replace(/\s+$/g,''),w.debug('sendButton, use default prompt: '+prompt)):prompt=R.value.replace(/\s+$/g,''),c=z.indexOf(prompt),(v=-1!==c)&&(x=`sendButton, prompt: "${prompt}"\n`+`already exists in history at index: ${c}`,w.debug(x)),z.length!==T||!L||v||o||(z.reverse(),R.value.length>0?A=R.value.replace(/\s+$/g,''):0===R.value.length&&(A=ne.replace(/\s+$/g,''),w.debug('sendButton, use default prompt:\n'+A)),w.debug('sendButton, update item in history:\n'+z[0]),z[0]=A,w.debug('sendButton, add new item to history:\n'+z[0]),o=!0),z.length<T&&!v&&!o&&(R.value.length>0?A=R.value.replace(/\s+$/g,''):0===R.value.length&&(A=ne.replace(/\s+$/g,''),w.debug('sendButton, use default prompt:\n'+A)),w.debug('sendButton, add new item to history:\n'+A),z.push(A),o=!0),z.length>0){var a=0;z.forEach(e=>{prompt=e.replace(/\s+$/g,''),z[a]=prompt,a++}),w.debug('sendButton, cleaned history for trailing whitespaces')}if(z.length>1){var s=z.length,i=[...new Set(z)];s>(z=i).length&&w.debug('sendButton, removed duplicates from history array: '+(s-z.length)+' element|s')}var d,c=1,m=[],u={};z.forEach(e=>{d='<span id="opt_'+oe.prompt_history_id+'_'+c+"\" class=\"ss-option-delete\"><i class=\"mdib mdib-close mdib-16px ml-1 mr-2\"></i></span>"+e,u={text:e,html:d,display:!0,selected:!1,disabled:!1},m.push(u),c++}),C!==undefined||null!==C?C.setData(m):w.error('FATAL: slimSelect NOT available'),z.length>0&&($("#prompt_history_container").show(),$("#clear").show()),S&&(w.debug('sendButton, save prompt history to cookie'),e.removeCookie({name:l.chat_prompt}),e.writeCookie({name:l.chat_prompt,data:z,secure:p}))}document.getElementById('md_result').innerHTML='',$("#result").hide(),$("#spinner").show(),r()}),document.getElementById('reset').addEventListener('click',e=>{e.preventDefault(),e.stopPropagation(),w.debug('resetButton, clear input prompt|response'),document.getElementById("prompt").value='',document.getElementById("response").value='',$("#spinner").hide(),$("#response").hide()}),document.getElementById('clear').addEventListener('click',t=>{t.preventDefault(),t.stopPropagation(),W=!1,$('#clearHistory').modal('show');document.getElementById('clearHistory');const o=document.getElementById('accecptClearHistory'),n=document.getElementById('dismissClearHistory');o.addEventListener('click',t=>{W=!1,t.preventDefault(),t.stopPropagation(),W||(w.warn('resetButton, perform clearHistory'),W=!0),z=[],e.removeCookie({name:l.chat_prompt}),$("#prompt_history_container").hide(),$("#clear").hide()}),n.addEventListener('click',e=>{e.preventDefault(),e.stopPropagation(),w.debug('resetButton, skipped clearHistory')})})},messageHandler:(e,t)=>{var o=JSON.stringify(t,undefined,2);return x='received message from '+e+': '+o,w.debug(x),'command'===t.type&&'module_initialized'===t.action&&w.info(t.text),!0},setState:e=>{H.state=e},getState:()=>H.state}})(j1,window);